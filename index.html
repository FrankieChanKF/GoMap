<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | go</title>
    <!-- 添加必要的 CSP 頭部 -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: gap: wss:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; connect-src *">
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
</head>
<body>
    <!-- 添加 GPS 權限提示覆蓋層 -->
    <div id="gps-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; display:flex; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:10px; text-align:center;">
            <h2>需要位置權限</h2>
            <p>此應用需要訪問您的位置以提供完整功能</p>
            <button id="enable-gps-btn" style="padding:10px 20px; background:#4CAF50; color:white; border:none; border-radius:5px; cursor:pointer;">
                允許位置訪問
            </button>
        </div>
    </div>

    <!-- 原有 Unity 容器 -->
    <div id="unity-container" class="unity-desktop">
        <!-- 原有內容保持不變 -->
    </div>

    <script>
        // 全局變量存儲 Unity 實例
        var unityInstance = null;
        
        // 當頁面完全加載後
        window.addEventListener('load', function() {
            // 顯示 GPS 權限請求覆蓋層
            document.getElementById('gps-overlay').style.display = 'flex';
            
            // 綁定按鈕點擊事件
            document.getElementById('enable-gps-btn').addEventListener('click', function() {
                requestGPSPermission();
                document.getElementById('gps-overlay').style.display = 'none';
            });
            
            // 原有 Unity 加載代碼...
        });

        // GPS 權限請求函數
        function requestGPSPermission() {
            if (!navigator.geolocation) {
                console.error("Geolocation is not supported by this browser.");
                return;
            }
            
            // 高精度模式，適用於移動設備
            var options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    // 成功獲取位置
                    console.log("Position acquired:", position);
                    
                    // 將位置數據發送到 Unity
                    if (unityInstance) {
                        var coords = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        unityInstance.SendMessage('GPSController', 'OnLocationReceived', JSON.stringify(coords));
                    }
                },
                function(error) {
                    // 處理錯誤
                    console.error("Error getting location:", error);
                    
                    // 根據錯誤代碼提供用戶反饋
                    var errorMsg = "無法獲取位置: ";
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += "用戶拒絕了位置權限請求";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += "位置信息不可用";
                            break;
                        case error.TIMEOUT:
                            errorMsg += "獲取位置超時";
                            break;
                        case error.UNKNOWN_ERROR:
                            errorMsg += "未知錯誤";
                            break;
                    }
                    
                    alert(errorMsg);
                },
                options
            );
        }
        
        // 暴露給 Unity 調用的函數
        window.RequestGPSUpdate = function() {
            requestGPSPermission();
        };
    </script>
</body>
</html>